# CNB æµæ°´çº¿é…ç½® - ç£åŠ›é“¾æŽ¥ä¸‹è½½åˆ° OneDrive

"**":
  api_trigger_magnet:
    - name: magnet-download-test
      docker:
        image: node:20-slim
      stages:
        - name: Install tools
          script: |
            sed -i 's/deb.debian.org/mirrors.cloud.tencent.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true
            apt-get update && apt-get install -y --no-install-recommends aria2 curl netcat-openbsd

        - name: Network diagnostics
          script: |
            echo "ðŸ” ç½‘ç»œè¯Šæ–­..."
            echo ""
            echo "ðŸ“ å½“å‰ IP:"
            curl -fsSL --connect-timeout 5 ifconfig.me 2>/dev/null || echo "æ— æ³•èŽ·å–"
            echo ""
            echo ""
            echo "ðŸŒ æµ‹è¯• HTTP è¿žæŽ¥:"
            curl -fsSL --connect-timeout 5 -o /dev/null -w "  baidu.com: %{http_code}\n" https://www.baidu.com 2>/dev/null || echo "  baidu.com: å¤±è´¥"
            curl -fsSL --connect-timeout 5 -o /dev/null -w "  github.com: %{http_code}\n" https://github.com 2>/dev/null || echo "  github.com: å¤±è´¥"
            echo ""
            echo "ðŸ”Œ æµ‹è¯• UDP ç«¯å£ (DHT):"
            nc -zu -w2 router.bittorrent.com 6881 && echo "  router.bittorrent.com:6881 âœ…" || echo "  router.bittorrent.com:6881 âŒ (UDPå¯èƒ½è¢«å°)"
            nc -zu -w2 dht.transmissionbt.com 6881 && echo "  dht.transmissionbt.com:6881 âœ…" || echo "  dht.transmissionbt.com:6881 âŒ"
            echo ""
            echo "ðŸ”Œ æµ‹è¯• TCP Tracker:"
            nc -zv -w2 tracker.opentrackr.org 1337 2>&1 | head -1 || echo "  tracker.opentrackr.org:1337 âŒ"
            echo ""

        - name: Get trackers
          script: |
            echo "ðŸ“¡ èšåˆèŽ·å– Tracker åˆ—è¡¨..."
            ALL_TRACKERS=""
            
            # æº1: adysec (æœ€å…¨)
            echo "ðŸ”¹ [1/5] adysec/tracker..."
            ADYSEC=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/adysec/tracker/main/tracker_all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            [ -n "$ADYSEC" ] && echo "   âœ… $(echo "$ADYSEC" | tr ',' '\n' | grep -v '^$' | wc -l) trackers" || echo "   âŒ èŽ·å–å¤±è´¥"
            [ -n "$ADYSEC" ] && ALL_TRACKERS="$ADYSEC"
            
            # æº2: XIU2 all
            echo "ðŸ”¹ [2/5] XIU2 all..."
            XIU2=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            [ -n "$XIU2" ] && echo "   âœ… $(echo "$XIU2" | tr ',' '\n' | grep -v '^$' | wc -l) trackers" || echo "   âŒ èŽ·å–å¤±è´¥"
            [ -n "$XIU2" ] && { [ -n "$ALL_TRACKERS" ] && ALL_TRACKERS="${ALL_TRACKERS},${XIU2}" || ALL_TRACKERS="$XIU2"; }
            
            # æº3: XIU2 http (HTTP tracker æ›´å®¹æ˜“ç©¿é€é˜²ç«å¢™)
            echo "ðŸ”¹ [3/5] XIU2 http..."
            XIU2_HTTP=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/http.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            [ -n "$XIU2_HTTP" ] && echo "   âœ… $(echo "$XIU2_HTTP" | tr ',' '\n' | grep -v '^$' | wc -l) trackers" || echo "   âŒ èŽ·å–å¤±è´¥"
            [ -n "$XIU2_HTTP" ] && { [ -n "$ALL_TRACKERS" ] && ALL_TRACKERS="${ALL_TRACKERS},${XIU2_HTTP}" || ALL_TRACKERS="$XIU2_HTTP"; }
            
            # æº4: ngosang
            echo "ðŸ”¹ [4/5] ngosang..."
            NGOSANG=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            [ -n "$NGOSANG" ] && echo "   âœ… $(echo "$NGOSANG" | tr ',' '\n' | grep -v '^$' | wc -l) trackers" || echo "   âŒ èŽ·å–å¤±è´¥"
            [ -n "$NGOSANG" ] && { [ -n "$ALL_TRACKERS" ] && ALL_TRACKERS="${ALL_TRACKERS},${NGOSANG}" || ALL_TRACKERS="$NGOSANG"; }
            
            # æº5: å¤‡ç”¨
            echo "ðŸ”¹ [5/5] å¤‡ç”¨åˆ—è¡¨..."
            BACKUP="http://tracker.bt4g.com:2095/announce,https://tracker.tamersunion.org:443/announce,http://open.acgnxtracker.com:80/announce,udp://tracker.opentrackr.org:1337/announce,udp://open.stealth.si:80/announce,udp://exodus.desync.com:6969/announce,udp://tracker.openbittorrent.com:6969/announce"
            [ -n "$ALL_TRACKERS" ] && ALL_TRACKERS="${ALL_TRACKERS},${BACKUP}" || ALL_TRACKERS="$BACKUP"
            
            # åŽ»é‡
            BEFORE=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l)
            ALL_TRACKERS=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | sort -u | tr '\n' ',' | sed 's/,$//')
            AFTER=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l)
            echo ""
            echo "ðŸ“Š åŽ»é‡: $BEFORE â†’ $AFTER ä¸ªå”¯ä¸€ Tracker"
            echo "$ALL_TRACKERS" > /tmp/trackers.txt

        - name: Download magnet
          script: |
            echo "=========================================="
            echo "ðŸš€ å¼€å§‹ä¸‹è½½ç£åŠ›é“¾æŽ¥"
            echo "=========================================="
            
            # æ£€æŸ¥ MAGNET å˜é‡
            if [ -z "$MAGNET" ]; then
              echo "âŒ é”™è¯¯: MAGNET çŽ¯å¢ƒå˜é‡ä¸ºç©º!"
              exit 1
            fi
            echo "ðŸ“¥ MAGNET: ${MAGNET:0:60}..."
            echo ""
            
            # åŠ è½½ Tracker
            if [ -s /tmp/trackers.txt ]; then
              TRACKERS=$(cat /tmp/trackers.txt)
              echo "ðŸ“¡ å·²åŠ è½½ $(echo "$TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l) ä¸ª Tracker"
            else
              echo "âš ï¸ Tracker æ–‡ä»¶ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨"
              TRACKERS="http://tracker.bt4g.com:2095/announce,udp://tracker.opentrackr.org:1337/announce"
            fi
            echo ""
            
            mkdir -p /downloads
            
            echo "â³ å¯åŠ¨ aria2c (è¶…æ—¶15åˆ†é’Ÿ)..."
            echo "   å¦‚æžœé•¿æ—¶é—´æ˜¾ç¤º 0B/sï¼Œè¯´æ˜Žæ‰¾ä¸åˆ° peers"
            echo ""
            
            aria2c "$MAGNET" \
              --dir=/downloads \
              --bt-tracker="$TRACKERS" \
              --bt-max-peers=200 \
              --max-connection-per-server=16 \
              --split=16 \
              --min-split-size=1M \
              --file-allocation=none \
              --seed-time=0 \
              --check-integrity=true \
              --continue=true \
              --max-concurrent-downloads=5 \
              --enable-dht=true \
              --enable-dht6=true \
              --bt-enable-lpd=true \
              --enable-peer-exchange=true \
              --bt-request-peer-speed-limit=10M \
              --bt-stop-timeout=900 \
              --summary-interval=3 \
              --console-log-level=notice \
              --show-console-readout=true \
              --human-readable=true \
              --download-result=full
            
            EXIT_CODE=$?
            echo ""
            echo "=========================================="
            if [ $EXIT_CODE -eq 0 ]; then
              echo "âœ… ä¸‹è½½å®Œæˆ!"
            else
              echo "âŒ ä¸‹è½½å¤±è´¥æˆ–è¶…æ—¶ (exit code: $EXIT_CODE)"
            fi
            echo ""
            echo "ðŸ“ ä¸‹è½½ç›®å½•å†…å®¹:"
            ls -lah /downloads/ 2>/dev/null || echo "  (ç©º)"
            echo ""
            echo "ðŸ“Š æ–‡ä»¶å¤§å°:"
            du -sh /downloads/* 2>/dev/null || echo "  æ— æ–‡ä»¶"
            echo "=========================================="
