# CNB æµæ°´çº¿é…ç½® - é€šç”¨æ–‡ä»¶ä¸‹è½½ä»»åŠ¡

"**":
  api_trigger_download:
    - name: file-download-task
      docker:
        image: node:20-slim
      stages:
        - name: Install deps
          script: |
            set -e
            echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
            sed -i 's/deb.debian.org/mirrors.cloud.tencent.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true
            apt-get update
            apt-get install -y --no-install-recommends ca-certificates curl aria2
            update-ca-certificates
            rm -rf /var/lib/apt/lists/*
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

        - name: System info
          script: |
            echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
            uname -a || true
            echo ""
            echo "=== ç£ç›˜ç©ºé—´ ==="
            df -h / || true
            echo ""
            echo "=== å†…å­˜ ==="
            free -h || true
            echo ""
            echo "=== å¤–ç½‘ IP ==="
            curl -fsSL --connect-timeout 5 ifconfig.me 2>/dev/null || echo "æ— æ³•èŽ·å–"
            echo ""
            echo "================"

        - name: Validate env
          script: |
            set -e
            echo "ðŸ” éªŒè¯çŽ¯å¢ƒå˜é‡..."
            
            if [ -z "$DOWNLOAD_URL" ]; then
              echo "âŒ DOWNLOAD_URL is required"
              exit 1
            fi
            echo "  DOWNLOAD_URL: present âœ…"
            
            if [ -n "${TARGET_FOLDER:-}" ]; then
              echo "  TARGET_FOLDER: ${TARGET_FOLDER} âœ…"
            fi
            
            if [ -n "${TIMEOUT_MINUTES:-}" ]; then
              echo "  TIMEOUT_MINUTES: ${TIMEOUT_MINUTES} âœ…"
            else
              echo "  TIMEOUT_MINUTES: (default: 30)"
            fi
            
            echo "âœ… çŽ¯å¢ƒå˜é‡éªŒè¯é€šè¿‡"

        - name: Prepare workspace
          script: |
            set -e
            echo "ðŸ”§ å‡†å¤‡å·¥ä½œç›®å½•..."
            mkdir -p /downloads
            mkdir -p /root/.cache/aria2
            echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"

        - name: Download file
          script: |
            set -e
            echo "=========================================="
            echo "ðŸš€ å¼€å§‹ä¸‹è½½"
            echo "=========================================="
            
            TIMEOUT_MINUTES="${TIMEOUT_MINUTES:-30}"
            TIMEOUT_SECONDS=$((TIMEOUT_MINUTES * 60))
            echo "â±ï¸ è¶…æ—¶è®¾ç½®: ${TIMEOUT_MINUTES} åˆ†é’Ÿ"
            echo ""
            
            echo "â³ å¯åŠ¨ä¸‹è½½..."
            START_TIME=$(date +%s)
            
            timeout "${TIMEOUT_SECONDS}s" aria2c "$DOWNLOAD_URL" \
              --dir=/downloads \
              --max-connection-per-server=16 \
              --split=16 \
              --min-split-size=1M \
              --file-allocation=none \
              --continue=true \
              --max-concurrent-downloads=5 \
              --summary-interval=30 \
              --console-log-level=notice \
              --human-readable=true \
              --download-result=full || EXIT_CODE=$?
            
            END_TIME=$(date +%s)
            DURATION=$((END_TIME - START_TIME))
            
            echo ""
            echo "=========================================="
            echo "ðŸ“Š ä¸‹è½½ç»Ÿè®¡"
            echo "=========================================="
            echo "â±ï¸ è€—æ—¶: ${DURATION} ç§’"
            
            if [ "${EXIT_CODE:-0}" = "0" ]; then
              echo "âœ… ä¸‹è½½å®Œæˆ!"
            elif [ "${EXIT_CODE:-0}" = "124" ]; then
              echo "âš ï¸ ä¸‹è½½è¶…æ—¶ (${TIMEOUT_MINUTES}åˆ†é’Ÿ)"
            else
              echo "âš ï¸ é€€å‡ºç : ${EXIT_CODE:-unknown}"
            fi
            
            echo ""
            echo "ðŸ“ ä¸‹è½½ç›®å½•å†…å®¹:"
            ls -lah /downloads/ 2>/dev/null || echo "  (ç©º)"
            echo ""
            echo "ðŸ“Š æ–‡ä»¶å¤§å°:"
            du -sh /downloads/* 2>/dev/null || echo "  æ— æ–‡ä»¶"
            echo "=========================================="
