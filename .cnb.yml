# CNB æµæ°´çº¿é…ç½® - ç£åŠ›é“¾æŽ¥ä¸‹è½½åˆ° OneDrive

"**":
  api_trigger_magnet:
    - name: magnet-download-test
      docker:
        image: node:20-slim
      stages:
        - name: Install tools
          script: |
            echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
            sed -i 's/deb.debian.org/mirrors.cloud.tencent.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true
            apt-get update
            apt-get install -y --no-install-recommends aria2 curl ca-certificates
            update-ca-certificates
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

        - name: Prepare environment
          script: |
            echo "ðŸ”§ å‡†å¤‡çŽ¯å¢ƒ..."
            mkdir -p /root/.cache/aria2
            mkdir -p /downloads
            echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"

        - name: Get trackers
          script: |
            echo "ðŸ“¡ èšåˆèŽ·å– Tracker åˆ—è¡¨..."
            ALL_TRACKERS=""
            
            echo "ðŸ”¹ [1/4] adysec/tracker..."
            ADYSEC=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/adysec/tracker/main/tracker_all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$ADYSEC" ]; then
              echo "   âœ… $(echo "$ADYSEC" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              ALL_TRACKERS="$ADYSEC"
            fi
            
            echo "ðŸ”¹ [2/4] XIU2 all..."
            XIU2=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$XIU2" ]; then
              echo "   âœ… $(echo "$XIU2" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$XIU2"; else ALL_TRACKERS="$XIU2"; fi
            fi
            
            echo "ðŸ”¹ [3/4] XIU2 http..."
            XIU2_HTTP=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/http.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$XIU2_HTTP" ]; then
              echo "   âœ… $(echo "$XIU2_HTTP" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$XIU2_HTTP"; else ALL_TRACKERS="$XIU2_HTTP"; fi
            fi
            
            echo "ðŸ”¹ [4/4] ngosang..."
            NGOSANG=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$NGOSANG" ]; then
              echo "   âœ… $(echo "$NGOSANG" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$NGOSANG"; else ALL_TRACKERS="$NGOSANG"; fi
            fi
            
            BACKUP="http://tracker.bt4g.com:2095/announce,https://tracker.tamersunion.org:443/announce,udp://tracker.opentrackr.org:1337/announce,udp://open.stealth.si:80/announce"
            if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$BACKUP"; else ALL_TRACKERS="$BACKUP"; fi
            
            BEFORE=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l)
            ALL_TRACKERS=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | sort -u | tr '\n' ',' | sed 's/,$//')
            AFTER=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l)
            echo "ðŸ“Š åŽ»é‡: $BEFORE â†’ $AFTER ä¸ª Tracker"
            echo "$ALL_TRACKERS" > /tmp/trackers.txt

        - name: Download magnet
          script: |
            echo "=========================================="
            echo "ðŸš€ å¼€å§‹ä¸‹è½½ç£åŠ›é“¾æŽ¥"
            echo "=========================================="
            
            if [ -z "$MAGNET" ]; then
              echo "âŒ MAGNET çŽ¯å¢ƒå˜é‡ä¸ºç©º!"
              exit 1
            fi
            echo "ðŸ“¥ MAGNET: $MAGNET"
            echo ""
            
            TRACKERS=$(cat /tmp/trackers.txt 2>/dev/null || echo "udp://tracker.opentrackr.org:1337/announce")
            echo "ðŸ“¡ Tracker æ•°é‡: $(echo "$TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l)"
            echo ""
            
            echo "â³ å¯åŠ¨ aria2c..."
            echo ""
            
            aria2c "$MAGNET" \
              --dir=/downloads \
              --bt-tracker="$TRACKERS" \
              --bt-max-peers=200 \
              --max-connection-per-server=16 \
              --split=16 \
              --min-split-size=1M \
              --file-allocation=none \
              --seed-time=0 \
              --check-integrity=true \
              --continue=true \
              --max-concurrent-downloads=5 \
              --enable-dht=true \
              --disable-ipv6=true \
              --bt-enable-lpd=true \
              --enable-peer-exchange=true \
              --bt-request-peer-speed-limit=10M \
              --bt-stop-timeout=1800 \
              --summary-interval=10 \
              --console-log-level=notice \
              --show-console-readout=true \
              --human-readable=true \
              --download-result=full \
              --dht-file-path=/root/.cache/aria2/dht.dat \
              --save-session=/root/.cache/aria2/session
            
            EXIT_CODE=$?
            echo ""
            echo "=========================================="
            if [ "$EXIT_CODE" = "0" ]; then
              echo "âœ… ä¸‹è½½å®Œæˆ!"
            else
              echo "âš ï¸ é€€å‡ºç : $EXIT_CODE"
            fi
            echo ""
            echo "ðŸ“ ä¸‹è½½ç›®å½•:"
            ls -lah /downloads/
            echo ""
            du -sh /downloads/* 2>/dev/null || echo "æ— æ–‡ä»¶"
            echo "=========================================="
