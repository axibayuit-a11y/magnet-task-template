# CNB æµæ°´çº¿é…ç½® - æ–‡ä»¶ä¸‹è½½ä»»åŠ¡

"**":
  api_trigger_download:
    - name: file-download-task
      runner:
        tags: cnb:arch:amd64
        cpus: 1
      docker:
        image: node:20-slim
      stages:
        - name: Install deps
          script: |
            set -e
            echo "ðŸ“¦ å®‰è£…ä¾èµ–..."
            sed -i 's/deb.debian.org/mirrors.cloud.tencent.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true
            apt-get update
            apt-get install -y --no-install-recommends ca-certificates curl aria2
            update-ca-certificates
            rm -rf /var/lib/apt/lists/*
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

        - name: System info
          script: |
            echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
            echo "CPU æ ¸æ•°: $(nproc || echo unknown)"
            echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}') å¯ç”¨"
            echo "å¤–ç½‘ IP: $(curl -fsSL --connect-timeout 5 ifconfig.me 2>/dev/null || echo unknown)"
            echo "================"

        - name: Get trackers
          script: |
            echo "ðŸ“¡ èŽ·å– Tracker åˆ—è¡¨..."
            ALL_TRACKERS=""
            
            XIU2=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/XIU2/TrackersListCollection/master/all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$XIU2" ]; then
              echo "âœ… XIU2: $(echo "$XIU2" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              ALL_TRACKERS="$XIU2"
            fi
            
            NGOSANG=$(curl -fsSL --connect-timeout 15 "https://raw.githubusercontent.com/ngosang/trackerslist/master/trackers_all.txt" 2>/dev/null | grep -v '^$' | tr '\n' ',' | sed 's/,$//' || echo "")
            if [ -n "$NGOSANG" ]; then
              echo "âœ… ngosang: $(echo "$NGOSANG" | tr ',' '\n' | grep -v '^$' | wc -l) trackers"
              if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$NGOSANG"; else ALL_TRACKERS="$NGOSANG"; fi
            fi
            
            BACKUP="http://tracker.bt4g.com:2095/announce,udp://tracker.opentrackr.org:1337/announce,udp://open.stealth.si:80/announce"
            if [ -n "$ALL_TRACKERS" ]; then ALL_TRACKERS="$ALL_TRACKERS,$BACKUP"; else ALL_TRACKERS="$BACKUP"; fi
            
            ALL_TRACKERS=$(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | sort -u | tr '\n' ',' | sed 's/,$//')
            echo "ðŸ“Š å…± $(echo "$ALL_TRACKERS" | tr ',' '\n' | grep -v '^$' | wc -l) ä¸ªå”¯ä¸€ Tracker"
            echo "$ALL_TRACKERS" > /tmp/trackers.txt

        - name: Download
          script: |
            set -e
            echo "=========================================="
            echo "ðŸš€ å¼€å§‹ä¸‹è½½"
            echo "=========================================="
            
            if [ -z "$DOWNLOAD_URL" ]; then
              echo "âŒ DOWNLOAD_URL is required"
              exit 1
            fi
            
            TIMEOUT_MINUTES="${TIMEOUT_MINUTES:-60}"
            echo "â±ï¸ è¶…æ—¶: ${TIMEOUT_MINUTES} åˆ†é’Ÿ"
            echo ""
            
            mkdir -p /downloads
            mkdir -p /root/.cache/aria2
            
            # åˆ¤æ–­æ˜¯ç£åŠ›é“¾æŽ¥è¿˜æ˜¯æ™®é€š URL
            if echo "$DOWNLOAD_URL" | grep -q "^magnet:"; then
              echo "ðŸ§² æ£€æµ‹åˆ°ç£åŠ›é“¾æŽ¥"
              TRACKERS=$(cat /tmp/trackers.txt 2>/dev/null || echo "")
              
              # bt-stop-timeout: 600ç§’(10åˆ†é’Ÿ)æ— è¿›åº¦è‡ªåŠ¨åœæ­¢
              timeout "$((TIMEOUT_MINUTES * 60))s" aria2c "$DOWNLOAD_URL" \
                --dir=/downloads \
                --bt-tracker="$TRACKERS" \
                --bt-max-peers=200 \
                --max-connection-per-server=16 \
                --file-allocation=none \
                --seed-time=0 \
                --enable-dht=true \
                --disable-ipv6=true \
                --bt-enable-lpd=true \
                --enable-peer-exchange=true \
                --bt-stop-timeout=600 \
                --summary-interval=30 \
                --console-log-level=notice \
                --human-readable=true \
                --download-result=full || EXIT_CODE=$?
              
              if [ "${EXIT_CODE:-0}" != "0" ]; then
                echo ""
                echo "âš ï¸ ç£åŠ›ä¸‹è½½å¤±è´¥ï¼Œå¯èƒ½åŽŸå› ï¼š"
                echo "   1. èµ„æºæ— äººåšç§ï¼ˆå¤ªå†·é—¨ï¼‰"
                echo "   2. ç£åŠ›é“¾æŽ¥æ— æ•ˆ"
                echo "   3. ç½‘ç»œæ— æ³•è¿žæŽ¥ DHT/Tracker"
              fi
            else
              echo "ðŸ”— æ£€æµ‹åˆ°æ™®é€š URL"
              timeout "$((TIMEOUT_MINUTES * 60))s" aria2c "$DOWNLOAD_URL" \
                --dir=/downloads \
                --max-connection-per-server=16 \
                --split=16 \
                --file-allocation=none \
                --continue=true \
                --summary-interval=30 \
                --console-log-level=notice \
                --human-readable=true \
                --download-result=full || EXIT_CODE=$?
            fi
            
            echo ""
            echo "=========================================="
            if [ "${EXIT_CODE:-0}" = "0" ]; then
              echo "âœ… ä¸‹è½½å®Œæˆ!"
            else
              echo "âš ï¸ é€€å‡ºç : ${EXIT_CODE:-unknown}"
            fi
            echo ""
            echo "ðŸ“ ä¸‹è½½ç›®å½•:"
            ls -lah /downloads/
            du -sh /downloads/* 2>/dev/null || echo "æ— æ–‡ä»¶"
            echo "=========================================="
